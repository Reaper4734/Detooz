============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\CP\plans\Detooz\backend
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 106 items

tests\test_auth.py ........                                              [  7%]
tests\test_feedback.py ...........                                       [ 17%]
tests\test_guardian.py ........                                          [ 25%]
tests\test_manual_scan.py ..................                             [ 42%]
tests\test_reputation.py .............                                   [ 54%]
tests\test_scan.py FFFFF..                                               [ 61%]
tests\test_services.py ...........                                       [ 71%]
tests\test_sms.py ..........                                             [ 81%]
tests\test_trusted_sender.py ..........                                  [ 90%]
tests\test_user.py ..........                                            [100%]

================================== FAILURES ===================================
_________________ TestScanEndpoints.test_analyze_text_message _________________

self = <test_scan.TestScanEndpoints object at 0x00000183FAED9450>
authenticated_client = <httpx.AsyncClient object at 0x00000183FAEA7590>

    @pytest.mark.asyncio
    async def test_analyze_text_message(self, authenticated_client: AsyncClient):
        """Test scanning a text message"""
        response = await authenticated_client.post(
            "/api/scan/analyze",
            json={
                "message": "Hello, this is a test message.",
                "platform": "SMS"
            }
        )
>       assert response.status_code == 200
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests\test_scan.py:22: AssertionError
______________ TestScanEndpoints.test_analyze_high_risk_message _______________

self = <test_scan.TestScanEndpoints object at 0x00000183FAED9590>
authenticated_client = <httpx.AsyncClient object at 0x00000183FB5F7410>

    @pytest.mark.asyncio
    async def test_analyze_high_risk_message(self, authenticated_client: AsyncClient):
        """Test scanning a high risk message"""
        response = await authenticated_client.post(
            "/api/scan/analyze",
            json={
                "message": "URGENT: Your account is suspended. Click here: bit.ly/12345",
                "platform": "WHATSAPP"
            }
        )
>       assert response.status_code == 200
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests\test_scan.py:38: AssertionError
___________________ TestScanEndpoints.test_get_scan_history ___________________

self = <test_scan.TestScanEndpoints object at 0x00000183FAE4FE10>
authenticated_client = <httpx.AsyncClient object at 0x00000183FB6C2510>

    @pytest.mark.asyncio
    async def test_get_scan_history(self, authenticated_client: AsyncClient):
        """Test getting scan history"""
        # Create scan first
        await authenticated_client.post(
            "/api/scan/analyze",
            json={"message": "History test", "platform": "SMS"}
        )
    
        response = await authenticated_client.get("/api/scan/history")
        assert response.status_code == 200
        data = response.json()
        assert isinstance(data, list)
>       assert len(data) >= 1
E       assert 0 >= 1
E        +  where 0 = len([])

tests\test_scan.py:55: AssertionError
___________________ TestScanEndpoints.test_get_scan_detail ____________________

self = <test_scan.TestScanEndpoints object at 0x00000183FAF30050>
authenticated_client = <httpx.AsyncClient object at 0x00000183FB5F7410>

    @pytest.mark.asyncio
    async def test_get_scan_detail(self, authenticated_client: AsyncClient):
        """Test getting details of a specific scan"""
        # Create scan
        scan_res = await authenticated_client.post(
            "/api/scan/analyze",
            json={"message": "Detail test", "platform": "SMS"}
        )
>       scan_id = scan_res.json()["scan_id"]
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'scan_id'

tests\test_scan.py:65: KeyError
_________________ TestScanEndpoints.test_mark_false_positive __________________

self = <test_scan.TestScanEndpoints object at 0x00000183FAEFFAD0>
authenticated_client = <httpx.AsyncClient object at 0x00000183FB5F7350>

    @pytest.mark.asyncio
    async def test_mark_false_positive(self, authenticated_client: AsyncClient):
        """Test marking a scan as false positive"""
        # Create scan
        scan_res = await authenticated_client.post(
            "/api/scan/analyze",
            json={"message": "Safe message flagged as risky", "platform": "SMS"}
        )
>       scan_id = scan_res.json()["scan_id"]
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'scan_id'

tests\test_scan.py:82: KeyError
============================== warnings summary ===============================
app\services\scam_detector.py:15
  C:\CP\plans\Detooz\backend\app\services\scam_detector.py:15: FutureWarning: 
  
  All support for the `google.generativeai` package has ended. It will no longer be receiving 
  updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
  See README for more details:
  
  https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md
  
    import google.generativeai as genai

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_scan.py::TestScanEndpoints::test_analyze_text_message - ass...
FAILED tests/test_scan.py::TestScanEndpoints::test_analyze_high_risk_message
FAILED tests/test_scan.py::TestScanEndpoints::test_get_scan_history - assert ...
FAILED tests/test_scan.py::TestScanEndpoints::test_get_scan_detail - KeyError...
FAILED tests/test_scan.py::TestScanEndpoints::test_mark_false_positive - KeyE...
================== 5 failed, 101 passed, 1 warning in 24.81s ==================
