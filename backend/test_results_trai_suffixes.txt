============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\CP\plans\Detooz\backend
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 14 items

tests\test_services.py ...........F..                                    [100%]

================================== FAILURES ===================================
_________________ TestTraiLogic.test_trai_marketing_exception _________________

self = <test_services.TestTraiLogic object at 0x000001CD11E60410>

    @pytest.mark.asyncio
    async def test_trai_marketing_exception(self):
        """Test that TRAI regulated sender marketing is downgraded to LOW risk"""
        # Trigger loan_scam pattern: "pre-approved loan"
        # TRAI sender + -P suffix = Marketing (LOW)
        message = "Dear customer, your pre-approved loan of 500000 is ready. Apply now. -P"
    
        result = await self.detector.analyze_quick(message, sender="AD-HDFCBK")
        assert result["risk_level"] == "LOW"
        assert result["scam_type"] == "Marketing/Spam"
    
        # However, KYC scam should still be HIGH even from TRAI header
        result_scam = await self.detector.analyze_quick(
            "Your account is blocked. Update KYC immediately or PAN will be suspended. -S",
            sender="AD-HDFCBK"
        )
>       assert result_scam["risk_level"] == "HIGH"
E       AssertionError: assert 'LOW' == 'HIGH'
E         
E         - HIGH
E         + LOW

tests\test_services.py:129: AssertionError
============================== warnings summary ===============================
app\services\scam_detector.py:15
  C:\CP\plans\Detooz\backend\app\services\scam_detector.py:15: FutureWarning: 
  
  All support for the `google.generativeai` package has ended. It will no longer be receiving 
  updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
  See README for more details:
  
  https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md
  
    import google.generativeai as genai

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_services.py::TestTraiLogic::test_trai_marketing_exception
=================== 1 failed, 13 passed, 1 warning in 0.88s ===================
