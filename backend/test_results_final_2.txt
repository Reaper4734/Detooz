============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\CP\plans\Detooz\backend
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 106 items

tests\test_auth.py ........                                              [  7%]
tests\test_feedback.py ...........                                       [ 17%]
tests\test_guardian.py ........                                          [ 25%]
tests\test_manual_scan.py ..................                             [ 42%]
tests\test_reputation.py .............                                   [ 54%]
tests\test_scan.py F..FF..                                               [ 61%]
tests\test_services.py ...........                                       [ 71%]
tests\test_sms.py ..........                                             [ 81%]
tests\test_trusted_sender.py ..........                                  [ 90%]
tests\test_user.py ..........                                            [100%]

================================== FAILURES ===================================
_________________ TestScanEndpoints.test_analyze_text_message _________________

self = <test_scan.TestScanEndpoints object at 0x000002C1CC975450>
authenticated_client = <httpx.AsyncClient object at 0x000002C1CC96AD50>

    @pytest.mark.asyncio
    async def test_analyze_text_message(self, authenticated_client: AsyncClient):
        """Test scanning a text message"""
        response = await authenticated_client.post(
            "/api/scan/analyze",
            json={
                "message": "Hello, this is a test message.",
                "sender": "+919876543210",
                "platform": "SMS"
            }
        )
        assert response.status_code == 200
        data = response.json()
        assert "risk_level" in data
        assert "confidence" in data
>       assert "scan_id" in data
E       AssertionError: assert 'scan_id' in {'confidence': 1.0, 'created_at': '2026-01-17T06:07:28.911855', 'guardian_alerted': False, 'id': 1, ...}

tests\test_scan.py:27: AssertionError
___________________ TestScanEndpoints.test_get_scan_detail ____________________

self = <test_scan.TestScanEndpoints object at 0x000002C1CC8EFCE0>
authenticated_client = <httpx.AsyncClient object at 0x000002C1CD09EC90>

    @pytest.mark.asyncio
    async def test_get_scan_detail(self, authenticated_client: AsyncClient):
        """Test getting details of a specific scan"""
        # Create scan
        scan_res = await authenticated_client.post(
            "/api/scan/analyze",
            json={"message": "Detail test", "sender": "+919876543210", "platform": "SMS"}
        )
>       scan_id = scan_res.json()["scan_id"]
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'scan_id'

tests\test_scan.py:67: KeyError
_________________ TestScanEndpoints.test_mark_false_positive __________________

self = <test_scan.TestScanEndpoints object at 0x000002C1CC9639B0>
authenticated_client = <httpx.AsyncClient object at 0x000002C1CCBF6990>

    @pytest.mark.asyncio
    async def test_mark_false_positive(self, authenticated_client: AsyncClient):
        """Test marking a scan as false positive"""
        # Create scan
        scan_res = await authenticated_client.post(
            "/api/scan/analyze",
            json={"message": "Safe message flagged as risky", "sender": "+919876543210", "platform": "SMS"}
        )
>       scan_id = scan_res.json()["scan_id"]
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'scan_id'

tests\test_scan.py:84: KeyError
============================== warnings summary ===============================
app\services\scam_detector.py:15
  C:\CP\plans\Detooz\backend\app\services\scam_detector.py:15: FutureWarning: 
  
  All support for the `google.generativeai` package has ended. It will no longer be receiving 
  updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
  See README for more details:
  
  https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md
  
    import google.generativeai as genai

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_scan.py::TestScanEndpoints::test_analyze_text_message - Ass...
FAILED tests/test_scan.py::TestScanEndpoints::test_get_scan_detail - KeyError...
FAILED tests/test_scan.py::TestScanEndpoints::test_mark_false_positive - KeyE...
================== 3 failed, 103 passed, 1 warning in 22.59s ==================
